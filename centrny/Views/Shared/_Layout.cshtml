@using centrny.Controllers
@inject centrny.Models.CenterContext DbContext
@{
    Layout = null;
    var resourceCulture = Context.Session.GetString("ResourceCulture") ?? System.Threading.Thread.CurrentThread.CurrentUICulture.TwoLetterISOLanguageName;
    resourceCulture = resourceCulture.StartsWith("ar", StringComparison.OrdinalIgnoreCase) ? "ar" : "en";
    var isRtl = resourceCulture == "ar";
    var dir = isRtl ? "rtl" : "ltr";

    var sidebarPages = User.Identity.IsAuthenticated
        ? LayoutController.GetSidebarPagesForUser(DbContext, Context.Session)
        : new List<SidebarPageViewModel>();

    string logoutText = isRtl ? "تسجيل الخروج" : "Logout";
    string loginText = isRtl ? "تسجيل الدخول" : "Login";
}
<!DOCTYPE html>
<html lang="@resourceCulture" dir="@dir">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>@ViewData["Title"] - Centrny</title>

    <!-- Google fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" crossorigin="" />

    <!-- Theme CSS -->
    <link rel="stylesheet" href="~/css/vendors.css">
    <link rel="stylesheet" href="~/css/main.css">

    <!-- Allow per-page styles -->
    @RenderSection("Styles", required: false)

    <!-- RTL overrides and Full-view behavior -->
    <style>
        :root {
            --body-color: @(Context.Session.GetString("RootBodyColor") ?? "#fff");
            --button-color: @(Context.Session.GetString("RootButtonColor") ?? "#007bff");
            --body-font-color: @(Context.Session.GetString("RootBodyFont") ?? "#000");
            --button-font-color: @(Context.Session.GetString("RootButtonFontColor") ?? "#000");
            --button-font-color2: @(Context.Session.GetString("RootButtonFontColor2") ?? "#fff");
            --background-color: @(Context.Session.GetString("RootBackgroundColor") ?? "#eee");
           
            --sidebar-width: 280px;
        }

        .site-background {
            background-color: var(--background-color) !important;
        }

        .site-body {
            background-color: var(--body-color) !important;
            color: var(--body-font-color) !important;
        }

        .btn1, btn2 {
            background-color: var(--button-color) !important;
            color: var(--button-font-color) !important;
        }

        .btn2 { 
            color: var(--button-font-color2) !important;
        }

        /* Place sidebar on the right in RTL */
        [dir="rtl"] .dashboard__sidebar {
            right: 0 !important;
            left: auto !important;
            border-left: 1px solid #e5e7eb;
            border-right: none;
            transition: transform .3s ease;
        }

        /* Default visible state (no translate) */
        [dir="rtl"] .dashboard__sidebar {
            transform: translateX(0) !important;
        }

        /* Hidden state: slide out to the right */
        [dir="rtl"] .dashboard.-sidebar-hidden .dashboard__sidebar,
        [dir="rtl"] .js-dashboard-home-9.-sidebar-hidden .dashboard__sidebar {
            transform: translateX(100%) !important;
        }

        /* Reserve space for sidebar on the right when visible */
        [dir="rtl"] .dashboard__main {
            margin-right: var(--sidebar-width) !important;
            margin-left: 0 !important;
            transition: margin-right .3s ease;
        }

        /* When sidebar is hidden: full-width content */
        [dir="rtl"] .dashboard.-sidebar-hidden .dashboard__main,
        [dir="rtl"] .js-dashboard-home-9.-sidebar-hidden .dashboard__main {
            margin-right: 0 !important;
            margin-left: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Ensure wrapper/content expand to full width when hidden */
        [dir="rtl"] .dashboard.-sidebar-hidden .content-wrapper,
        [dir="rtl"] .js-dashboard-home-9.-sidebar-hidden .content-wrapper,
        [dir="rtl"] .dashboard.-sidebar-hidden .dashboard__content,
        [dir="rtl"] .js-dashboard-home-9.-sidebar-hidden .dashboard__content {
            margin-right: 0 !important;
            margin-left: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        /* Flip sidebar item layout */
        [dir="rtl"] .sidebar__item a {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .sidebar__item i {
            margin-right: 0;
            margin-left: 15px;
        }

        /* Header tweaks for RTL */
        [dir="rtl"] .header__explore {
            order: 2;
        }

        [dir="rtl"] .header__logo {
            margin-right: 30px;
            margin-left: 0;
            order: 1;
        }

        [dir="rtl"] .ml-15 {
            margin-left: 0;
            margin-right: 15px;
        }

        /* Mobile: content should not reserve sidebar space */
        @@media (max-width: 992px) {
            [dir="rtl"] .dashboard__main {
                margin-right: 0 !important;
            }
            /* On small screens, when sidebar is visible it overlays from right */
            [dir="rtl"] .dashboard__sidebar {
                position: fixed;
                top: 0;
                bottom: 0;
                height: 100vh;
                z-index: 1040;
            }
        }
    </style>
</head>

<body class="preloader-visible" data-barba="wrapper">
    <!-- preloader start -->
    <div class="preloader js-preloader">
        <div class="preloader__bg"></div>
    </div>
    <!-- preloader end -->

    <div class="barba-container" data-barba="container">
        <main class="main-content">
            <header class="header -dashboard -dark-bg-dark-1 js-header">
                <div class="header__container py-20 px-30">
                    <div class="row justify-between items-center">
                        <div class="col-auto">
                            <div class="d-flex items-center">
                                <div class="header__explore text-dark-1">
                                    <button class="d-flex items-center js-dashboard-home-9-sidebar-toggle" aria-label="Toggle sidebar">
                                        <i class="icon -dark-text-white icon-explore"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-auto">
                            <div class="d-flex items-center">
                                <!-- Dark Mode Toggle -->
                                <div class="relative sm:d-none">
                                    <button class="js-darkmode-toggle text-light-1 d-flex items-center justify-center size-50 rounded-16 -hover-dshb-header-light" aria-label="Toggle dark mode">
                                        <i class="text-24 icon icon-night"></i>
                                    </button>
                                </div>

                                <!-- Language Toggle -->
                                <form method="post" asp-controller="Layout" asp-action="SetResourceLanguage" style="display:inline;" class="@(isRtl ? "mr-15" : "ml-15")">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="resourceCulture" value="@(isRtl ? "en" : "ar")" />
                                    <input type="hidden" name="returnUrl" id="returnUrlInput" />
                                    <button type="submit" class="button -md -rounded bg-light-4 text-light-1">
                                        @(isRtl ? "English" : "Arabic")
                                    </button>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </header>

            <div class="content-wrapper js-content-wrapper">
                <div class="dashboard -home-9 js-dashboard-home-9">
                    <div class="dashboard__sidebar scroll-bar-1">
                        <div class="sidebar -dashboard">
                            @if (sidebarPages.Any())
                            {
                                foreach (var sidebarPage in sidebarPages)
                                {
                                    <div class="sidebar__item @(ViewContext.RouteData.Values["controller"]?.ToString() == sidebarPage.Controller && ViewContext.RouteData.Values["action"]?.ToString() == sidebarPage.Action ? "-is-active -dark-bg-dark-2" : "")">
                                        <a asp-controller="@sidebarPage.Controller" asp-action="@sidebarPage.Action"
                                           class="d-flex items-center text-17 lh-1 fw-500">
                                            <i class="@sidebarPage.Icon text-20 @(isRtl ? "ml-15" : "mr-15")"></i>
                                            @sidebarPage.Text
                                        </a>
                                    </div>
                                }
                            }
                            @if (User.Identity.IsAuthenticated)
                            {
                                <div class="sidebar__item">
                                    <a href="#" class="d-flex items-center text-17 lh-1 fw-500" id="logoutBtn">
                                        <i class="text-20 icon-power @(isRtl ? "ml-15" : "mr-15")"></i>
                                        @logoutText
                                    </a>
                                </div>
                            }
                            else
                            {
                                <div class="sidebar__item">
                                    <a asp-controller="Login" asp-action="Index" class="d-flex items-center text-17 lh-1 fw-500">
                                        <i class="text-20 icon-power @(isRtl ? "ml-15" : "mr-15")"></i>
                                        @loginText
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="dashboard__main site-background">
                        <div class="dashboard__content bg-light-4 site-body">
                            @RenderBody()
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" crossorigin=""></script>
    <script src="~/js/vendors.js"></script>
    <script src="~/js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const isRTL = document.documentElement.dir === 'rtl';
            const dashboard = document.querySelector('.js-dashboard-home-9');
            const sidebarToggle = document.querySelector('.js-dashboard-home-9-sidebar-toggle');

            // Preserve current URL for language toggle return
            const returnUrlInput = document.getElementById('returnUrlInput');
            if (returnUrlInput) returnUrlInput.value = window.location.pathname + window.location.search + window.location.hash;

            if (isRTL && dashboard && sidebarToggle) {
                // Ensure the theme's LTR handler doesn't fight us; we only toggle the class
                const onToggle = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dashboard.classList.toggle('-sidebar-hidden');
                };

                // Use capture to win over theme's listener if any
                sidebarToggle.addEventListener('click', onToggle, true);
            }
        });
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>