@using Microsoft.Extensions.Localization
@using System.Globalization
@using centrny.Controllers
@model OnlineStudentController.StudentDashboardViewModel
@inject IStringLocalizerFactory LocalizerFactory
@{
    var Localizer = LocalizerFactory.Create("OnlineStudent", System.Reflection.Assembly.GetExecutingAssembly().GetName().Name);
    var isArabic = CultureInfo.CurrentUICulture.TwoLetterISOLanguageName == "ar";
    var htmlLang = CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
    var htmlDir = isArabic ? "rtl" : "ltr";

    // Show actual root name only; if null show a dash (no default "EduCenter")
    var rootName = Model.Student.RootCodeNavigation?.RootName ?? "-";
    ViewData["Title"] = $"{Model.Student.StudentName} - {Localizer["Title_Dashboard"]}";
    Layout = null;

    var today = DateOnly.FromDateTime(DateTime.Today);
    var age = today.Year - Model.Student.StudentBirthdate.Year;
    if (Model.Student.StudentBirthdate > today.AddYears(-age)) age--;
}
<!DOCTYPE html>
<html lang="@htmlLang" dir="@htmlDir">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"]</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    @if (isArabic)
    {
        <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css" rel="stylesheet" />
    }
    else
    {
        <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet" />
    }
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />
    <link href="~/css/OnlineStudent.css" rel="stylesheet" />
    <style>
        html, body {
            margin: 0;
            padding: 0;
        }

        .navbar, .modern-navbar {
            margin-top: 0 !important;
            border-top: 0 !important;
        }
    </style>
</head>
<body>
    <!-- Hidden anti-forgery token for AJAX logout -->
    <div id="afTokenContainer" style="display:none;">
        @Html.AntiForgeryToken()
    </div>

    <!-- All localization keys must stay INSIDE this opening tag (no stray < or early >) -->
    <div id="js-online-localization"
         data-nav-dashboard="@Localizer["Nav_Dashboard"]"
         data-nav-learning="@Localizer["Nav_LearningCenter"]"
         data-badge-subscribed="@Localizer["Badge_Subscribed"]"
         data-badge-regular="@Localizer["Badge_Regular"]"
         data-section-academic="@Localizer["Section_AcademicOverview"]"
         data-stat-subjects="@Localizer["Stat_Subjects"]"
         data-stat-exams="@Localizer["Stat_Exams"]"
         data-stat-attendance="@Localizer["Stat_Attendance"]"
         data-stat-average="@Localizer["Stat_Average"]"
         data-section-student-information="@Localizer["Section_StudentInformation"]"
         data-label-full-name="@Localizer["Label_FullName"]"
         data-label-age="@Localizer["Label_Age"]"
         data-label-age-suffix="@Localizer["Label_AgeSuffix"]"
         data-label-academic-year="@Localizer["Label_AcademicYear"]"
         data-label-branch="@Localizer["Label_Branch"]"
         data-label-contact-number="@Localizer["Label_ContactNumber"]"
         data-label-parent-contact="@Localizer["Label_ParentContact"]"
         data-label-member-since="@Localizer["Label_MemberSince"]"
         data-section-enrolled-subjects="@Localizer["Section_EnrolledSubjects"]"
         data-section-examination-results="@Localizer["Section_ExaminationResults"]"
         data-empty-no-subjects-title="@Localizer["Empty_NoSubjectsTitle"]"
         data-empty-no-subjects-message="@Localizer["Empty_NoSubjectsMessage"]"
         data-empty-no-exams-title="@Localizer["Empty_NoExamsTitle"]"
         data-empty-no-exams-message="@Localizer["Empty_NoExamsMessage"]"
         data-label-subject="@Localizer["Label_Subject"]"
         data-label-teacher="@Localizer["Label_Teacher"]"
         data-label-date="@Localizer["Label_Date"]"
         data-label-type="@Localizer["Label_Type"]"
         data-label-status="@Localizer["Label_Status"]"
         data-status-passed="@Localizer["Status_Passed"]"
         data-status-failed="@Localizer["Status_Failed"]"
         data-type-exam="@Localizer["Type_Exam"]"
         data-type-quiz="@Localizer["Type_Quiz"]"
         data-online-badge="@Localizer["Online_Badge"]"
         data-fee-label="@Localizer["Fee_Label"]"
         data-loading-subjects="@Localizer["Loading_Subjects"]"
         data-loading-exams="@Localizer["Loading_Exams"]"
         data-alert-dashboard-loaded="@Localizer["Alert_DashboardLoaded"]"
         data-alert-dashboard-failed="@Localizer["Alert_DashboardFailed"]"
         data-alert-load-subjects-failed="@Localizer["Alert_LoadSubjectsFailed"]"
         data-alert-load-exams-failed="@Localizer["Alert_LoadExamsFailed"]"
         data-not-assigned="@Localizer["NotAssigned"]"
         data-not-provided="@Localizer["NotProvided"]"
         data-error="@Localizer["Error"]"
         data-locale="@htmlLang"
         data-dir="@htmlDir"
         data-section-attended-sessions="@Localizer["Section_AttendedSessions"]"
         data-loading-sessions="@Localizer["Loading_Sessions"]"
         data-empty-no-sessions-title="@Localizer["Empty_NoSessionsTitle"]"
         data-empty-no-sessions-message="@Localizer["Empty_NoSessionsMessage"]"
         data-alert-load-sessions-failed="@Localizer["Alert_LoadSessionsFailed"]"
         data-source-online="@Localizer["Source_Online"]"
         data-source-center="@Localizer["Source_Center"]"></div>

    <nav class="navbar navbar-expand-lg modern-navbar">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="/OnlineStudent">
                <i class="fas fa-graduation-cap"></i>
                @rootName
            </a>
            <!-- Keep toggler simple; JS will open the custom sidebar -->
            <button class="navbar-toggler" type="button" aria-label="Open navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav @(!isArabic ? "me-auto" : "ms-auto")">
                    <li class="nav-item">
                        <a class="nav-link" href="/OnlineStudent">
                            <i class="fas fa-tachometer-alt"></i>
                            @Localizer["Nav_Dashboard"]
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/OnlineStudent/Learning">
                            <i class="fas fa-book-reader"></i>
                            @Localizer["Nav_LearningCenter"]
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/OnlineStudent/Homework">
                            <i class="fas fa-clipboard-check"></i>
                            @Localizer["Nav_Homework"]
                        </a>
                    </li>
                </ul>
                <div class="language-switcher d-flex align-items-center gap-2">
                    <button class="language-btn @(isArabic ? "" : "active")" onclick="switchLanguage('en')">
                        <i class="fas fa-globe"></i> EN
                    </button>
                    <button class="language-btn @(isArabic ? "active" : "")" onclick="switchLanguage('ar')">
                        <i class="fas fa-globe"></i> AR
                    </button>
                    <button class="language-btn logout-btn" onclick="logoutStudent()" title="@Localizer["Logout"]" aria-label="@Localizer["Logout"]">
                        <i class="fas fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="mobile-nav-overlay" onclick="closeMobileNav()"></div>

    <div class="mobile-nav-sidebar">
        <div class="mobile-nav-header">
            <a href="/OnlineStudent" class="mobile-nav-brand">
                <i class="fas fa-graduation-cap me-2"></i>
                @rootName
            </a>
            <button class="mobile-nav-close" onclick="closeMobileNav()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mobile-nav-links">
            <a href="/OnlineStudent" class="mobile-nav-link active">
                <i class="fas fa-tachometer-alt"></i>
                @Localizer["Nav_Dashboard"]
            </a>
            <a href="/OnlineStudent/Learning" class="mobile-nav-link">
                <i class="fas fa-book-reader"></i>
                @Localizer["Nav_LearningCenter"]
            </a>
            <a href="/OnlineStudent/Homework" class="mobile-nav-link">
                <i class="fas fa-clipboard-check"></i>
                @Localizer["Nav_Homework"]
            </a>
        </div>
        <div class="mobile-language-switcher">
            <div class="mobile-language-title">@Localizer["Label_Language"]</div>
            <div class="mobile-language-options">
                <button class="language-btn @(isArabic ? "" : "active")" onclick="switchLanguage('en')">English</button>
                <button class="language-btn @(isArabic ? "active" : "")" onclick="switchLanguage('ar')">العربية</button>
                <button class="language-btn logout-btn mt-2" onclick="logoutStudent()">
                    <i class="fas fa-right-from-bracket"></i> @Localizer["Logout"]
                </button>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <div id="alertContainer" class="alert-container"></div>

        <div class="student-header">
            <div class="row">
                <div class="col-md-8">
                    <h1 class="page-title">
                        <i class="fas fa-user-graduate"></i>
                        @Model.Student.StudentName
                    </h1>
                    <div class="student-meta">
                        <span class="badge bg-primary">ID: @Model.Student.StudentCode</span>
                        <span class="text-light">
                            @(Model.Student.YearCodeNavigation?.YearName ?? Localizer["NotAssigned"])
                            -
                            @(Model.Student.BranchCodeNavigation?.BranchName ?? Localizer["NotAssigned"])
                        </span>
                    </div>
                </div>
                <div class="col-md-4 text-@(isArabic ? "start" : "end")">
                    <span id="subscription-status" class="badge @(Model.IsSubscribed ? "bg-success" : "bg-secondary")">
                        @(Model.IsSubscribed ? Localizer["Badge_Subscribed"] : Localizer["Badge_Regular"])
                    </span>
                </div>
            </div>
        </div>

        <div class="stats-overview">
            <h3 class="mb-0">@Localizer["Section_AcademicOverview"]</h3>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-item">
                    <div class="stat-number" id="subjectsCount">@Model.EnrolledSubjects.Count</div>
                    <div class="stat-label">@Localizer["Stat_Subjects"]</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="examsCount">@Model.AttendedExams.Count</div>
                    <div class="stat-label">@Localizer["Stat_Exams"]</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="attendanceCount">@Model.TotalAttendanceCount</div>
                    <div class="stat-label">@Localizer["Stat_Attendance"]</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="averageGrade">--</div>
                    <div class="stat-label">@Localizer["Stat_Average"]</div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-user"></i>
                    @Localizer["Section_StudentInformation"]
                </h2>
            </div>
            <div class="section-content">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>@Localizer["Label_FullName"]</label>
                            <span>@Model.Student.StudentName</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>@Localizer["Label_Age"]</label>
                            <span>@age @Localizer["Label_AgeSuffix"]</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>@Localizer["Label_AcademicYear"]</label>
                            <span>@(Model.Student.YearCodeNavigation?.YearName ?? Localizer["NotAssigned"])</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>@Localizer["Label_Branch"]</label>
                            <span>@(Model.Student.BranchCodeNavigation?.BranchName ?? Localizer["NotAssigned"])</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>@Localizer["Label_ContactNumber"]</label>
                            <span>@(Model.Student.StudentPhone ?? Localizer["NotProvided"])</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>@Localizer["Label_ParentContact"]</label>
                            <span>@(Model.Student.StudentFatherPhone ?? Localizer["NotProvided"])</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>@Localizer["Label_MemberSince"]</label>
                            <span>@Model.Student.SubscribtionTime.ToString("MMMM yyyy")</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-book-open"></i>
                    @Localizer["Section_EnrolledSubjects"]
                </h2>
            </div>
            <div class="section-content">
                <div id="subjectsGrid" class="subjects-grid">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <span>@Localizer["Loading_Subjects"]</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-list"></i>
                    @Localizer["Section_ExaminationResults"]
                </h2>
            </div>
            <div class="section-content">
                <div id="examsGrid" class="exams-grid">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <span>@Localizer["Loading_Exams"]</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: Attended Sessions -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-user-check"></i>
                    @Localizer["Section_AttendedSessions"]
                </h2>
            </div>
            <div class="section-content">
                <div id="sessionsGrid" class="exams-grid">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <span>@Localizer["Loading_Sessions"]</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- END: Attended Sessions -->

    </div>

    <script>
        function switchLanguage(lang) {
            document.cookie = ".AspNetCore.Culture=c=" + lang + "|uic=" + lang + "; path=/; max-age=31536000";
            location.reload();
        }
        function closeMobileNav() {
            document.querySelector('.mobile-nav-sidebar')?.classList.remove('open');
            document.querySelector('.mobile-nav-overlay')?.classList.remove('show');
            document.body.classList.remove('mobile-nav-open');
        }

        async function logoutStudent() {
            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                const res = await fetch('/StudentLogin/Logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: '{}'
                });
                const data = await res.json().catch(() => null);
                if (res.ok && data?.success) {
                    window.location.href = data.redirectUrl || '/StudentLogin';
                } else {
                    alert(data?.error || 'Logout failed. Please try again.');
                }
            } catch (e) {
                alert('Network error. Please try again.');
            }
        }
    </script>
    <script src="~/js/OnlineStudent.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>